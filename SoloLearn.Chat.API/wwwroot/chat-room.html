<!DOCTYPE html>
<html>
<head>
    <link href="Content/bootstrap.css" rel="stylesheet" />
    <link href="Content/bootstrap-theme.min.css" rel="stylesheet" />
    <link href="Content/chat-room.css" rel="stylesheet" />

    <script src="Scripts/jquery-3.3.1.min.js"></script>
    <script src="Scripts/signalr.min.js"></script>
    <script src="Scripts/bootstrap.min.js"></script>

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {

            var connection = new signalR.HubConnectionBuilder().withUrl('/chatHub').build();
            var roomName = getUrlParameter("room");
            var lastMessage = "";
            var lastAuthor = "";

            connection.on("Receive", function (message) {

                if (message.content != lastMessage && message.Author != lastAuthor) {

                    var element = " <div class='incoming_msg'>" +
                        "    <div class='incoming_msg_img'> <img src='https://ptetutorials.com/images/user-profile.png'></div>" +
                        "    <div class='received_msg'>" +
                        "        <div class='received_withd_msg'>" +
                        "            <p>" + message.content + "</p>" +
                        "            <span class='time_date'> 11:01 AM    |    June 9</span>" +
                        "        </div>" +
                        "    </div>" +
                        "</div >";

                    $(".msg_history").append(element);

                    element = "";
                }

            });


            connection.start()
                .then(function () {
                    console.log('connection started');

                    connection.invoke("JoinRoom", roomName).catch(err => console.error(err.toString()));

                    document.getElementById('msg_send_btn').addEventListener('click', function (event) {

                        lastMessage = $(".write_msg").val();

                        connection.invoke("Send", { Content: lastMessage, RoomName: getUrlParameter("room") }).catch(err => console.error(err.toString()));

                        var element = "<div class='outgoing_msg'>" +
                            "    <div class='sent_msg'>" +
                            "       <p>" + $(".write_msg").val() + "</p>" +
                            "        <span class='time_date'> 11:01 AM    |    June 9</span>" +
                            "     </div>" +
                            " </div>";

                        $(".msg_history").append(element);

                        element = "";

                        $(".write_msg").val("");
                    });

                }).catch(error => {
                    console.error(error.message);
                });
        });

        $.ajax({
            type: "GET",
            url: "/api/Rooms",
            success(data) {

                var element = "";

                for (var i = 0; i < data.length; i++) {
                    element += "<div class='chat_list active_chat'>" +
                        "    <div class='chat_people'> " +
                        "         <div class='chat_img'><img src='https://ptetutorials.com/images/user-profile.png'></div>" +
                        "     <div class='chat_ib'>" +
                        "         <h5 style='margin-top: 15px;'><a href='chat-room.html?room=" + data[i].name +"'>" + data[i].name + "</a></h5>" +
                        "     </div>" +
                        "    </div> " +
                        " </div>";
                }

                $(".inbox_chat").append(element);

                element = "";
            }
        })

        function getUrlParameter(sParam) {
            var sPageURL = decodeURIComponent(window.location.search.substring(1)),
                sURLVariables = sPageURL.split('&'),
                sParameterName,
                i;

            for (i = 0; i < sURLVariables.length; i++) {
                sParameterName = sURLVariables[i].split('=');

                if (sParameterName[0] === sParam) {
                    return sParameterName[1] === undefined ? true : sParameterName[1];
                }
            }
        };

    </script>
</head>
<body>
    <div class="container">
        <h3 class=" text-center">Chating</h3>
        <div class="messaging">
            <div class="inbox_msg">
                <div class="inbox_people">
                    <div class="headind_srch">
                        <div class="recent_heading">
                            <h4>Rooms</h4>
                        </div>

                    </div>
                    <div class="inbox_chat">


                    </div>
                </div>
                <div class="mesgs">
                    <div class="msg_history">
                    </div>
                    <div class="type_msg">
                        <div class="input_msg_write">
                            <input type="text" class="write_msg" placeholder="Type a message" />
                            <button class="msg_send_btn" id="msg_send_btn" type="button"><i class="fa fa-paper-plane-o" aria-hidden="true"></i> >> </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</body>
</html>
